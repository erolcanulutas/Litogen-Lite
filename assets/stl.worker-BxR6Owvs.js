(function(){"use strict";function ut(o){const t=o.width,c=o.height,e=[];for(let l=0;l<c;l++){const u=[];for(let M=0;M<t;M++){const w=(l*t+M)*4,y=o.data[w],I=o.data[w+1],x=o.data[w+2],a=(.2126*y+.7152*I+.0722*x)/255;u.push(a)}e.push(u)}return{h:e,w:t,hPx:c}}function et(o,t){return[o[0]-t[0],o[1]-t[1],o[2]-t[2]]}function mt(o,t){return[o[1]*t[2]-o[2]*t[1],o[2]*t[0]-o[0]*t[2],o[0]*t[1]-o[1]*t[0]]}function Mt(o){const t=Math.hypot(o[0],o[1],o[2])||1;return[o[0]/t,o[1]/t,o[2]/t]}function gt(o){const t=new ArrayBuffer(84+o.length*50),c=new DataView(t);c.setUint32(80,o.length,!0);let e=84;for(const[l,u,M]of o){const w=Mt(mt(et(u,l),et(M,l)));c.setFloat32(e+0,w[0],!0),c.setFloat32(e+4,w[1],!0),c.setFloat32(e+8,w[2],!0),[...l,...u,...M].forEach((y,I)=>c.setFloat32(e+12+I*4,y,!0)),c.setUint16(e+48,0,!0),e+=50}return t}function rt(o,t,c){return Math.max(t,Math.min(c,o))}function nt(o,t,c){const e=t*(o.w-1),l=c*(o.hPx-1),u=Math.floor(e),M=Math.floor(l),w=rt(u+1,0,o.w-1),y=rt(M+1,0,o.hPx-1),I=e-u,x=l-M,a=o.h[M][u],R=o.h[M][w],d=o.h[y][u],P=o.h[y][w],q=a*(1-I)+R*I,E=d*(1-I)+P*I;return q*(1-x)+E*x}function ot(o){switch(o){case"draft":return{angMul:.8,radial:80,ringAngMax:480};case"high":return{angMul:2.8,radial:360,ringAngMax:2800};default:return{angMul:1.4,radial:180,ringAngMax:1400}}}function L(o,t,c,e){o.push([t,c,e])}const dt={id:"triangle",label:"Triangle (equilateral)",cropRatio:2/Math.sqrt(3),build:(o,t)=>{const{heightmap:c,minT:e,maxT:l,frameMm:u,emboss:M}=o,{widthMm:w,resolution:y,quality:I}=t;let x;I==="draft"?x={angMul:.45,radial:60,ringAngMax:0}:I==="normal"?x=ot("draft"):x=ot("normal");const a=[],R=w,d=R*Math.sqrt(3)/2,P=l-e,q=[-R/2,-d/3],E=[R/2,-d/3],A=[0,2*d/3];function X(n,i,s){const m=Math.min(n,i,s)*d;if(u>0&&m<=u)return l;const g=n*q[0]+i*E[0]+s*A[0],p=n*q[1]+i*E[1]+s*A[1],S=(g+R/2)/R,_=(2*d/3-p)/d,F=nt(c,1-S,_);return M==="back"?l-F*P:e+F*P}const b=Math.max(8,Math.floor(y*x.angMul)),T=[],r=[];for(let n=0;n<=b;n++){const i=[],s=[],m=n/b,g=b-n;for(let p=0;p<=g;p++){const S=p/b,_=1-m-S,F=_*q[0]+S*E[0]+m*A[0],f=_*q[1]+S*E[1]+m*A[1],$=X(_,S,m);i.push([F,f,$]),s.push([F,f,0])}T.push(i),r.push(s)}for(let n=0;n<b;n++){const i=b-n;for(let s=0;s<i;s++){const m=T[n][s],g=T[n][s+1],p=T[n+1][s];L(a,m,p,g),s+1<T[n+1].length&&L(a,g,p,T[n+1][s+1]);const S=r[n][s],_=r[n][s+1],F=r[n+1][s];L(a,S,_,F),s+1<r[n+1].length&&L(a,_,r[n+1][s+1],F)}}for(let n=0;n<b;n++)L(a,T[0][n],r[0][n],r[0][n+1]),L(a,T[0][n],r[0][n+1],T[0][n+1]);for(let n=0;n<b;n++)L(a,T[n][0],r[n][0],r[n+1][0]),L(a,T[n][0],r[n+1][0],T[n+1][0]);for(let n=0;n<b;n++){const i=b-n,s=b-n-1;L(a,T[n][i],r[n][i],r[n+1][s]),L(a,T[n][i],r[n+1][s],T[n+1][s])}return a}};function j(o,t,c,e){o.push([t,c,e])}const xt={id:"circle",label:"Circle",cropRatio:1,build:(o,t)=>{const{heightmap:c,minT:e,maxT:l,frameMm:u,emboss:M}=o,{widthMm:w,quality:y}=t,I=ot(y),x=[],a=w/2,R=(w-2*u)/2,d=u>.05&&R>0,P=l-e;function q(r,n){const i=(r+a)/(2*a),s=(a-n)/(2*a),m=nt(c,1-i,s);return M==="back"?l-m*P:e+m*P}const E=Math.max(72,Math.floor(c.w*I.angMul)),A=Math.max(10,I.radial),X=A+(d?5:0),b=[];for(let r=0;r<=X;r++){const n=[];let i,s=!1;if(d)if(r<=A)i=r/A*R;else{const m=r-A,g=X-A;i=R+m/g*(a-R),s=!0}else i=r/X*a;for(let m=0;m<E;m++){const g=m/E*Math.PI*2,p=Math.cos(g)*i,S=Math.sin(g)*i,_=s?l:q(p,S);n.push([p,S,_])}b.push(n)}for(let r=0;r<X;r++)for(let n=0;n<E;n++){const i=(n+1)%E,s=b[r][n],m=b[r][i],g=b[r+1][n],p=b[r+1][i];j(x,s,g,p),j(x,s,p,m);const S=[s[0],s[1],0],_=[m[0],m[1],0],F=[g[0],g[1],0],f=[p[0],p[1],0];j(x,S,f,F),j(x,S,_,f)}const T=b[b.length-1];for(let r=0;r<E;r++){const n=(r+1)%E,i=T[r],s=T[n],m=[i[0],i[1],0],g=[s[0],s[1],0];j(x,i,g,m),j(x,i,s,g)}return x}};function J(o,t,c,e){o.push([t,c,e])}function it(o,t,c){return Math.max(t,Math.min(c,o))}const pt={id:"hexagon",label:"Hexagon",cropRatio:2/Math.sqrt(3),build:(o,t)=>{const{heightmap:c,minT:e,maxT:l,frameMm:u,emboss:M}=o,{widthMm:w,resolution:y,quality:I}=t,x=ot(I),a=[],R=l-e,d=w/2,P=d*(2/Math.sqrt(3)),q=Math.max(0,u),E=Math.max(0,d-q),A=q>.001,X=2*P,b=2*d;function T(f,$,H){if(H)return l;const U=(f+P)/X,C=1-($+d)/b,D=it(1-U,0,1),G=it(C,0,1),N=nt(c,D,G);return M==="back"?l-N*R:e+N*R}const r=6,n=Math.max(10,Math.floor(x.radial*.8)),i=Math.max(4,Math.floor(y*x.angMul/6)),s=[],m=E/d,g=Math.floor(n*m),p=n;for(let f=0;f<=p;f++){const $=[];let H;if(A)if(f<=g)H=g===0?0:f/g*m;else{const C=p-g,D=f-g;H=m+D/C*(1-m)}else H=f/p;const U=A&&f>g;for(let C=0;C<r;C++){const D=C*Math.PI/3,G=(C+1)*Math.PI/3,N=Math.cos(D)*P,Y=Math.sin(D)*P,Z=Math.cos(G)*P,O=Math.sin(G)*P;for(let tt=0;tt<i;tt++){const h=tt/i,B=N+(Z-N)*h,k=Y+(O-Y)*h,V=B*H,v=k*H,z=T(V,v,U);$.push([V,v,z])}}s.push($)}const S=r*i;for(let f=0;f<p;f++)for(let $=0;$<S;$++){const H=($+1)%S,U=s[f][$],C=s[f][H],D=s[f+1][$],G=s[f+1][H];J(a,U,D,G),J(a,U,G,C);const N=[U[0],U[1],0],Y=[C[0],C[1],0],Z=[D[0],D[1],0],O=[G[0],G[1],0];J(a,N,O,Z),J(a,N,Y,O)}const _=s.length-1,F=s[_];for(let f=0;f<S;f++){const $=(f+1)%S,H=F[f],U=F[$],C=[H[0],H[1],0],D=[U[0],U[1],0];J(a,H,D,C),J(a,H,U,D)}return a}};function K(o,t,c,e){o.push([t,c,e])}function ht(o,t,c){return Math.max(t,Math.min(c,o))}const bt={id:"pentagon",label:"Pentagon",cropRatio:2*Math.cos(Math.PI/10)/(1+Math.cos(Math.PI/5)),build:(o,t)=>{const{heightmap:c,minT:e,maxT:l,frameMm:u,emboss:M}=o,{widthMm:w,resolution:y,quality:I}=t,x=ot(I),a=[],R=l-e,d=5,P=Math.cos(Math.PI/10),q=Math.cos(Math.PI/5),A=Math.max(.01,w)/(2*P),X=2*P*A,b=(1+q)*A,T=A*q,r=Math.max(0,u),n=T-r,i=r>.001&&n>1e-4,s=i?n/T:1,m=Math.PI/5,g=-Math.PI/2+m,p=[];for(let h=0;h<d;h++){const B=g+h*2*Math.PI/d;p.push({x:Math.cos(B)*A,y:Math.sin(B)*A})}let S=1/0,_=-1/0,F=1/0,f=-1/0;for(const h of p)S=Math.min(S,h.x),_=Math.max(_,h.x),F=Math.min(F,h.y),f=Math.max(f,h.y);const $=(S+_)/2,H=(F+f)/2,U=p.map(h=>({x:h.x-$,y:h.y-H}));function C(h,B,k){if(k)return l;const V=(h+X/2)/X,v=1-(B+b/2)/b,z=ht(1-V,0,1),W=ht(v,0,1),Q=nt(c,z,W);return M==="back"?l-Q*R:e+Q*R}const D=Math.max(10,Math.floor(x.radial*.8)),G=Math.max(4,Math.floor(y*x.angMul/d)),N=[],Y=Math.floor(D*s),Z=D;for(let h=0;h<=Z;h++){const B=[];let k;if(i)if(h<=Y)k=Y===0?0:h/Y*s;else{const v=Z-Y,z=h-Y;k=s+z/v*(1-s)}else k=h/Z;const V=i&&h>Y;for(let v=0;v<d;v++){const z=U[v],W=U[(v+1)%d];for(let Q=0;Q<G;Q++){const st=Q/G,at=z.x+(W.x-z.x)*st,ct=z.y+(W.y-z.y)*st,lt=at*k,ft=ct*k,It=C(lt,ft,V);B.push([lt,ft,It])}}N.push(B)}const O=d*G;for(let h=0;h<Z;h++)for(let B=0;B<O;B++){const k=(B+1)%O,V=N[h][B],v=N[h][k],z=N[h+1][B],W=N[h+1][k];K(a,V,z,W),K(a,V,W,v);const Q=[V[0],V[1],0],st=[v[0],v[1],0],at=[z[0],z[1],0],ct=[W[0],W[1],0];K(a,Q,ct,at),K(a,Q,st,ct)}const tt=N[N.length-1];for(let h=0;h<O;h++){const B=(h+1)%O,k=tt[h],V=tt[B],v=[k[0],k[1],0],z=[V[0],V[1],0];K(a,k,z,v),K(a,k,V,z)}return a}},wt=[dt,xt,pt,bt];function yt(o){const t=wt.find(c=>c.id===o);if(!t)throw new Error(`Unknown shape: ${o}`);return t}function Tt(o,t,c){return Math.max(t,Math.min(c,o))}function St(o){let t=1/0;const c=o.map(e=>e.map(l=>{let u=l[0],M=l[2],w=l[1];u=-u,M=-M;const y=[u,M,w];return t=Math.min(t,w),y}));if(isFinite(t)&&t!==0)for(const e of c)for(const l of e)l[2]-=t;return c}self.onmessage=async o=>{try{const t=o.data;if(!t.image||t.image.width===0||t.image.height===0)throw new Error("Invalid image data");if(t.layerHeight<=0)throw new Error("Invalid layer height");const c=Tt(Math.round(t.heightMm/t.layerHeight*2),400,1200),e=t.image,l=e.width/e.height,u=c,M=Math.max(8,Math.round(u*l)),y=new OffscreenCanvas(M,u).getContext("2d",{willReadFrequently:!0});if(!y)throw new Error("Failed to create OffscreenCanvas context");y.imageSmoothingEnabled=!0,y.imageSmoothingQuality="high",y.clearRect(0,0,M,u);const I=await createImageBitmap(e);y.drawImage(I,0,0,e.width,e.height,0,0,M,u),I.close();const x=y.getImageData(0,0,M,u),a=ut(x),d=yt(t.shapeId).build({heightmap:{w:a.w,hPx:a.hPx,h:a.h},minT:t.minT,maxT:t.maxT,frameMm:t.frameMm,emboss:t.emboss},{widthMm:t.widthMm,resolution:a.w,minT:t.minT,maxT:t.maxT,frameMm:t.frameMm,emboss:t.emboss,quality:t.quality}),P=St(d),q=gt(P),E={id:t.id,ok:!0,stl:q};self.postMessage(E,{transfer:[q]})}catch(t){const c={id:(o.data&&o.data.id)??-1,ok:!1,error:t?.message?String(t.message):"Unknown error"};self.postMessage(c)}}})();
