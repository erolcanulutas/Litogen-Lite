(function(){"use strict";function tt(o){const t=o.width,e=o.height,c=[];for(let l=0;l<e;l++){const h=[];for(let m=0;m<t;m++){const M=(l*t+m)*4,x=o.data[M],T=o.data[M+1],d=o.data[M+2],r=(.2126*x+.7152*T+.0722*d)/255;h.push(r)}c.push(h)}return{h:c,w:t,hPx:e}}function X(o,t){return[o[0]-t[0],o[1]-t[1],o[2]-t[2]]}function nt(o,t){return[o[1]*t[2]-o[2]*t[1],o[2]*t[0]-o[0]*t[2],o[0]*t[1]-o[1]*t[0]]}function ot(o){const t=Math.hypot(o[0],o[1],o[2])||1;return[o[0]/t,o[1]/t,o[2]/t]}function st(o){const t=new ArrayBuffer(84+o.length*50),e=new DataView(t);e.setUint32(80,o.length,!0);let c=84;for(const[l,h,m]of o){const M=ot(nt(X(h,l),X(m,l)));e.setFloat32(c+0,M[0],!0),e.setFloat32(c+4,M[1],!0),e.setFloat32(c+8,M[2],!0),[...l,...h,...m].forEach((x,T)=>e.setFloat32(c+12+T*4,x,!0)),e.setUint16(c+48,0,!0),c+=50}return t}function Y(o,t,e){return Math.max(t,Math.min(e,o))}function O(o,t,e){const c=t*(o.w-1),l=e*(o.hPx-1),h=Math.floor(c),m=Math.floor(l),M=Y(h+1,0,o.w-1),x=Y(m+1,0,o.hPx-1),T=c-h,d=l-m,r=o.h[m][h],R=o.h[m][M],y=o.h[x][h],_=o.h[x][M],P=r*(1-T)+R*T,A=y*(1-T)+_*T;return P*(1-d)+A*d}function N(o){switch(o){case"draft":return{angMul:.8,radial:80,ringAngMax:480};case"high":return{angMul:2.8,radial:360,ringAngMax:2800};default:return{angMul:1.4,radial:180,ringAngMax:1400}}}function z(o,t,e,c){o.push([t,e,c])}const et={id:"triangle",label:"Triangle (equilateral)",cropRatio:2/Math.sqrt(3),build:(o,t)=>{const{heightmap:e,minT:c,maxT:l,frameMm:h,emboss:m}=o,{widthMm:M,resolution:x,quality:T}=t;let d;T==="draft"?d={angMul:.45,radial:60,ringAngMax:0}:T==="normal"?d=N("draft"):d=N("normal");const r=[],R=M,y=R*Math.sqrt(3)/2,_=l-c,P=[-R/2,-y/3],A=[R/2,-y/3],H=[0,2*y/3];function D(n,i,s){const u=Math.min(n,i,s)*y;if(h>0&&u<=h)return l;const g=n*P[0]+i*A[0]+s*H[0],w=n*P[1]+i*A[1]+s*H[1],S=(g+R/2)/R,I=(2*y/3-w)/y,B=O(e,1-S,I);return m==="back"?l-B*_:c+B*_}const p=Math.max(8,Math.floor(x*d.angMul)),b=[],a=[];for(let n=0;n<=p;n++){const i=[],s=[],u=n/p,g=p-n;for(let w=0;w<=g;w++){const S=w/p,I=1-u-S,B=I*P[0]+S*A[0]+u*H[0],f=I*P[1]+S*A[1]+u*H[1],q=D(I,S,u);i.push([B,f,q]),s.push([B,f,0])}b.push(i),a.push(s)}for(let n=0;n<p;n++){const i=p-n;for(let s=0;s<i;s++){const u=b[n][s],g=b[n][s+1],w=b[n+1][s];z(r,u,w,g),s+1<b[n+1].length&&z(r,g,w,b[n+1][s+1]);const S=a[n][s],I=a[n][s+1],B=a[n+1][s];z(r,S,I,B),s+1<a[n+1].length&&z(r,I,a[n+1][s+1],B)}}for(let n=0;n<p;n++)z(r,b[0][n],a[0][n],a[0][n+1]),z(r,b[0][n],a[0][n+1],b[0][n+1]);for(let n=0;n<p;n++)z(r,b[n][0],a[n][0],a[n+1][0]),z(r,b[n][0],a[n+1][0],b[n+1][0]);for(let n=0;n<p;n++){const i=p-n,s=p-n-1;z(r,b[n][i],a[n][i],a[n+1][s]),z(r,b[n][i],a[n+1][s],b[n+1][s])}return r}};function V(o,t,e,c){o.push([t,e,c])}const at={id:"circle",label:"Circle",cropRatio:1,build:(o,t)=>{const{heightmap:e,minT:c,maxT:l,frameMm:h,emboss:m}=o,{widthMm:M,quality:x}=t,T=N(x),d=[],r=M/2,R=(M-2*h)/2,y=h>.05&&R>0,_=l-c;function P(a,n){const i=(a+r)/(2*r),s=(r-n)/(2*r),u=O(e,1-i,s);return m==="back"?l-u*_:c+u*_}const A=Math.max(72,Math.floor(e.w*T.angMul)),H=Math.max(10,T.radial),D=H+(y?5:0),p=[];for(let a=0;a<=D;a++){const n=[];let i,s=!1;if(y)if(a<=H)i=a/H*R;else{const u=a-H,g=D-H;i=R+u/g*(r-R),s=!0}else i=a/D*r;for(let u=0;u<A;u++){const g=u/A*Math.PI*2,w=Math.cos(g)*i,S=Math.sin(g)*i,I=s?l:P(w,S);n.push([w,S,I])}p.push(n)}for(let a=0;a<D;a++)for(let n=0;n<A;n++){const i=(n+1)%A,s=p[a][n],u=p[a][i],g=p[a+1][n],w=p[a+1][i];V(d,s,g,w),V(d,s,w,u);const S=[s[0],s[1],0],I=[u[0],u[1],0],B=[g[0],g[1],0],f=[w[0],w[1],0];V(d,S,f,B),V(d,S,I,f)}const b=p[p.length-1];for(let a=0;a<A;a++){const n=(a+1)%A,i=b[a],s=b[n],u=[i[0],i[1],0],g=[s[0],s[1],0];V(d,i,g,u),V(d,i,s,g)}return d}};function $(o,t,e,c){o.push([t,e,c])}function Z(o,t,e){return Math.max(t,Math.min(e,o))}const ct={id:"hexagon",label:"Hexagon",cropRatio:2/Math.sqrt(3),build:(o,t)=>{const{heightmap:e,minT:c,maxT:l,frameMm:h,emboss:m}=o,{widthMm:M,resolution:x,quality:T}=t,d=N(T),r=[],R=l-c,y=M/2,_=y*(2/Math.sqrt(3)),P=Math.max(0,h),A=Math.max(0,y-P),H=P>.001,D=2*_,p=2*y;function b(f,q,E){if(E)return l;const v=(f+_)/D,F=1-(q+y)/p,k=Z(1-v,0,1),C=Z(F,0,1),U=O(e,k,C);return m==="back"?l-U*R:c+U*R}const a=6,n=Math.max(10,Math.floor(d.radial*.8)),i=Math.max(4,Math.floor(x*d.angMul/6)),s=[],u=A/y,g=Math.floor(n*u),w=n;for(let f=0;f<=w;f++){const q=[];let E;if(H)if(f<=g)E=g===0?0:f/g*u;else{const F=w-g,k=f-g;E=u+k/F*(1-u)}else E=f/w;const v=H&&f>g;for(let F=0;F<a;F++){const k=F*Math.PI/3,C=(F+1)*Math.PI/3,U=Math.cos(k)*_,G=Math.sin(k)*_,W=Math.cos(C)*_,L=Math.sin(C)*_;for(let Q=0;Q<i;Q++){const j=Q/i,ut=U+(W-U)*j,ft=G+(L-G)*j,J=ut*E,K=ft*E,mt=b(J,K,v);q.push([J,K,mt])}}s.push(q)}const S=a*i;for(let f=0;f<w;f++)for(let q=0;q<S;q++){const E=(q+1)%S,v=s[f][q],F=s[f][E],k=s[f+1][q],C=s[f+1][E];$(r,v,k,C),$(r,v,C,F);const U=[v[0],v[1],0],G=[F[0],F[1],0],W=[k[0],k[1],0],L=[C[0],C[1],0];$(r,U,L,W),$(r,U,G,L)}const I=s.length-1,B=s[I];for(let f=0;f<S;f++){const q=(f+1)%S,E=B[f],v=B[q],F=[E[0],E[1],0],k=[v[0],v[1],0];$(r,E,k,F),$(r,E,v,k)}return r}},rt=[et,at,ct];function it(o){const t=rt.find(e=>e.id===o);if(!t)throw new Error(`Unknown shape: ${o}`);return t}function lt(o,t,e){return Math.max(t,Math.min(e,o))}function ht(o){let t=1/0;const e=o.map(c=>c.map(l=>{let h=l[0],m=l[2],M=l[1];h=-h,m=-m;const x=[h,m,M];return t=Math.min(t,M),x}));if(isFinite(t)&&t!==0)for(const c of e)for(const l of c)l[2]-=t;return e}self.onmessage=async o=>{try{const t=o.data;if(!t.image||t.image.width===0||t.image.height===0)throw new Error("Invalid image data");if(t.layerHeight<=0)throw new Error("Invalid layer height");const e=lt(Math.round(t.heightMm/t.layerHeight*2),400,1200),c=t.image,l=c.width/c.height,h=e,m=Math.max(8,Math.round(h*l)),x=new OffscreenCanvas(m,h).getContext("2d",{willReadFrequently:!0});if(!x)throw new Error("Failed to create OffscreenCanvas context");x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.clearRect(0,0,m,h);const T=await createImageBitmap(c);x.drawImage(T,0,0,c.width,c.height,0,0,m,h),T.close();const d=x.getImageData(0,0,m,h),r=tt(d),y=it(t.shapeId).build({heightmap:{w:r.w,hPx:r.hPx,h:r.h},minT:t.minT,maxT:t.maxT,frameMm:t.frameMm,emboss:t.emboss},{widthMm:t.widthMm,resolution:r.w,minT:t.minT,maxT:t.maxT,frameMm:t.frameMm,emboss:t.emboss,quality:t.quality}),_=ht(y),P=st(_),A={id:t.id,ok:!0,stl:P};self.postMessage(A,{transfer:[P]})}catch(t){const e={id:(o.data&&o.data.id)??-1,ok:!1,error:t?.message?String(t.message):"Unknown error"};self.postMessage(e)}}})();
