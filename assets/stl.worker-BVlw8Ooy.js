function D(t,o,n){return Math.max(o,Math.min(n,t))}function q(t,o,n,r,c){if(r<=0)return t;const M=new Float32Array(t.length),u=2*r+1;if(c===1)for(let s=0;s<n;s++){let f=0;const l=s*o;for(let a=-r;a<=r;a++)f+=t[l+D(a,0,o-1)];M[l]=f/u;for(let a=1;a<o;a++)f+=t[l+D(a+r,0,o-1)]-t[l+D(a-r-1,0,o-1)],M[l+a]=f/u}else for(let s=0;s<o;s++){let f=0;for(let l=-r;l<=r;l++)f+=t[D(l,0,n-1)*o+s];M[s]=f/u;for(let l=1;l<n;l++)f+=t[D(l+r,0,n-1)*o+s]-t[D(l-r-1,0,n-1)*o+s],M[l*o+s]=f/u}return M}function H(t,o,n,r){if(r<=0)return t;const c=Math.pow(r/100,2.2)*6,M=Math.floor(c),u=M+1,s=c-M,f=(h,g)=>{let A=h;return A=q(A,o,n,g,1),A=q(A,o,n,g,0),A},l=f(t,M),a=f(t,u),m=new Float32Array(t.length);for(let h=0;h<m.length;h++)m[h]=l[h]*(1-s)+a[h]*s;return m}function R(t,o,n,r,c,M){const u=t.width,s=t.height,f=t.data,l=new Float32Array(u*s);for(let m=0;m<s;m++){const h=s-1-m;for(let g=0;g<u;g++){const A=u-1-g,p=(h*u+A)*4;let U=(.2126*f[p]+.7152*f[p+1]+.0722*f[p+2])/255;r&&(U=1-U),U=Math.pow(D(U,0,1),c),l[m*u+g]=o+(1-U)*(n-o)}}return{th:H(l,u,s,M),wPx:u,hPx:s}}function Y(t,o,n,r){if(r<=0)return t;const c=new Uint8Array(t.length);for(let M=0;M<n;M++)for(let u=0;u<o;u++){const s=M*o+u;if(!t[s]){c[s]=0;continue}let f=!0;for(let l=-r;l<=r&&f;l++)for(let a=-r;a<=r&&f;a++){const m=u+a,h=M+l;if(m<0||h<0||m>=o||h>=n){f=!1;break}if(!t[h*o+m]){f=!1;break}}c[s]=f?1:0}return c}function x(t,o,n,r,c,M,u,s,f,l){const a=n/c,m=Math.max(0,Math.round(u*a)),h=m>0?Y(t,n,r,m):t,g=m>0?(()=>{const e=new Uint8Array(t.length);for(let i=0;i<e.length;i++)e[i]=t[i]&&!h[i]?1:0;return e})():new Uint8Array(t.length),A=[],p=(e,i,y)=>A.push([e,i,y]),U=c/n,W=M/r,d=e=>(e+.5)*U,b=e=>(e+.5)*W,T=e=>t[e]?g[e]?s==="front"?l:0:s==="front"?o[e]:0:f,F=e=>s==="front"?0:-T(e);for(let e=0;e<r-1;e++)for(let i=0;i<n-1;i++){const y=e*n+i;if(!t[y])continue;const S=y+1,z=y+n,B=y+n+1;p([d(i),T(y),b(e)],[d(i+1),T(S),b(e)],[d(i),T(z),b(e+1)]),p([d(i+1),T(S),b(e)],[d(i+1),T(B),b(e+1)],[d(i),T(z),b(e+1)]),p([d(i),F(y),b(e)],[d(i),F(z),b(e+1)],[d(i+1),F(S),b(e)]),p([d(i+1),F(S),b(e)],[d(i),F(z),b(e+1)],[d(i+1),F(B),b(e+1)])}const v=(e,i,y,S,z,B)=>{p([d(e),T(y),b(i)],[d(S),T(B),b(z)],[d(e),F(y),b(i)]),p([d(S),T(B),b(z)],[d(S),F(B),b(z)],[d(e),F(y),b(i)])};for(let e=0;e<r;e++)for(let i=0;i<n;i++){const y=e*n+i;t[y]&&((i===0||!t[y-1])&&v(i,e,y,i,e+1,y+n),(i===n-1||!t[y+1])&&v(i+1,e,y,i+1,e+1,y+n),(e===0||!t[y-n])&&v(i,e,y,i+1,e,y+1),(e===r-1||!t[y+n])&&v(i,e+1,y,i+1,e+1,y+1))}return A}function C(t){return t*Math.sqrt(3)/2}function G(t,o){return Math.abs(t)<=.5*(1+o)}function I(t,o,n,r,c,M,u,s){const f=C(r),l=new Uint8Array(o*n);for(let a=0;a<n;a++){const m=(a+.5)/n*2-1;for(let h=0;h<o;h++){const g=(h+.5)/o*2-1;l[a*o+h]=G(g,-m)?1:0}}return x(l,t,o,n,r,f,c,M,u,s)}function L(t,o,n,r,c,M,u,s){const f=r,l=new Uint8Array(o*n);for(let a=0;a<n;a++){const m=(a+.5)/n*2-1;for(let h=0;h<o;h++){const g=(h+.5)/o*2-1;l[a*o+h]=g*g+m*m<=1?1:0}}return x(l,t,o,n,r,f,c,M,u,s)}function V(t){const o=new ArrayBuffer(84+t.length*50),n=new DataView(o);n.setUint32(80,t.length,!0);let r=84;for(const c of t){r+=12;for(const M of c)n.setFloat32(r,M[0],!0),n.setFloat32(r+4,M[1],!0),n.setFloat32(r+8,M[2],!0),r+=12;r+=2}return o}function X(t,o,n,r,c){const M=new Float32Array(r*c),u=(o-1)/(r-1),s=(n-1)/(c-1);for(let f=0;f<c;f++){const l=f*s,a=Math.floor(l),m=Math.min(a+1,n-1),h=l-a;for(let g=0;g<r;g++){const A=g*u,p=Math.floor(A),U=Math.min(p+1,o-1),W=A-p,d=t[a*o+p],b=t[a*o+U],T=t[m*o+p],F=t[m*o+U],v=d*(1-W)+b*W,e=T*(1-W)+F*W;M[f*r+g]=v*(1-h)+e*h}}return M}self.onmessage=t=>{const o=t.data;if(o.type==="generate")try{const{mode:n,image:r,params:c}=o,M=new ImageData(r.data,r.width,r.height);let{th:u,wPx:s,hPx:f}=R(M,c.minT,c.maxT,c.invert,c.gamma,c.smoothPct);const l=5,a=n==="triangle"?c.widthMm*Math.sqrt(3)/2:c.widthMm,m=Math.max(s,Math.round(c.widthMm*l)),h=Math.max(f,Math.round(a*l));(m>s||h>f)&&(u=X(u,s,f,m,h),s=m,f=h);const g=n==="triangle"?I(u,s,f,c.widthMm,c.frameWmm,c.emboss,c.minT,c.maxT):L(u,s,f,c.widthMm,c.frameWmm,c.emboss,c.minT,c.maxT),A=V(g);self.postMessage({type:"stl",buffer:A},[A])}catch(n){self.postMessage({type:"error",error:(n==null?void 0:n.message)??String(n)})}};
